import discord
from discord.ext import commands
import sqlite3
from datetime import datetime, timedelta
import os
import asyncio
import time
import hashlib
import aiohttp
import ssl
from discord.ext import tasks
from db.mongo_adapters import mongo_enabled, AllianceMembersAdapter, UserProfilesAdapter

SECRET = "tB87#kPtkxqOS2"

class IDChannel(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.setup_database()
        self.log_directory = 'log'
        if not os.path.exists(self.log_directory):
            os.makedirs(self.log_directory)
            
        self.message_listeners = {}
            
        self.level_mapping = {
            31: "30-1", 32: "30-2", 33: "30-3", 34: "30-4",
            35: "FC 1", 36: "FC 1 - 1", 37: "FC 1 - 2", 38: "FC 1 - 3", 39: "FC 1 - 4",
            40: "FC 2", 41: "FC 2 - 1", 42: "FC 2 - 2", 43: "FC 2 - 3", 44: "FC 2 - 4",
            45: "FC 3", 46: "FC 3 - 1", 47: "FC 3 - 2", 48: "FC 3 - 3", 49: "FC 3 - 4",
            50: "FC 4", 51: "FC 4 - 1", 52: "FC 4 - 2", 53: "FC 4 - 3", 54: "FC 4 - 4",
            55: "FC 5", 56: "FC 5 - 1", 57: "FC 5 - 2", 58: "FC 5 - 3", 59: "FC 5 - 4",
            60: "FC 6", 61: "FC 6 - 1", 62: "FC 6 - 2", 63: "FC 6 - 3", 64: "FC 6 - 4",
            65: "FC 7", 66: "FC 7 - 1", 67: "FC 7 - 2", 68: "FC 7 - 3", 69: "FC 7 - 4",
            70: "FC 8", 71: "FC 8 - 1", 72: "FC 8 - 2", 73: "FC 8 - 3", 74: "FC 8 - 4",
            75: "FC 9", 76: "FC 9 - 1", 77: "FC 9 - 2", 78: "FC 9 - 3", 79: "FC 9 - 4",
            80: "FC 10", 81: "FC 10 - 1", 82: "FC 10 - 2", 83: "FC 10 - 3", 84: "FC 10 - 4"
        }

    def setup_database(self):
        if not os.path.exists('db'):
            os.makedirs('db')
            
        conn = sqlite3.connect('db/id_channel.sqlite')
        c = conn.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS id_channels
                     (guild_id INTEGER, 
                      alliance_id INTEGER,
                      channel_id INTEGER,
                      created_at TEXT,
                      created_by INTEGER,
                      UNIQUE(guild_id, channel_id))''')
        conn.commit()
        conn.close()

    def _get_member_alliance(self, fid: int):
        try:
            if mongo_enabled() and AllianceMembersAdapter is not None:
                doc = AllianceMembersAdapter.get_member(str(fid))
                if doc and (doc.get('alliance') is not None or doc.get('alliance_id') is not None):
                    return int(doc.get('alliance') or doc.get('alliance_id'))
        except Exception:
            pass

        try:
            with sqlite3.connect('db/users.sqlite') as users_db:
                cursor = users_db.cursor()
                cursor.execute("SELECT alliance FROM users WHERE fid = ?", (fid,))
                r = cursor.fetchone()
                return r[0] if r else None
        except Exception:
            return None

    def _check_member_exists(self, fid: int):
        try:
            if mongo_enabled() and AllianceMembersAdapter is not None:
                doc = AllianceMembersAdapter.get_member(str(fid))
                if doc:
                    return doc
        except Exception:
            pass

        try:
            with sqlite3.connect('db/users.sqlite') as users_db:
                cursor = users_db.cursor()
                cursor.execute("SELECT * FROM users WHERE fid = ?", (fid,))
                r = cursor.fetchone()
                if r:
                    # Convert tuple to dict-like for consistency if needed, or just return True
                    return {'fid': r[0], 'nickname': r[1], 'alliance': r[5]}
        except Exception:
            pass
        return None

    def _log_debug(self, message):
        try:
            with open('debug_id_channel.log', 'a', encoding='utf-8') as f:
                timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                f.write(f"[{timestamp}] {message}\n")
        except Exception:
            print(message)

    def _upsert_member_from_api(self, fid: int, nickname: str, furnace_lv: int, kid, stove_lv_content, alliance_id: int, avatar_image=None) -> bool:
        try:
            member_doc = {
                'fid': str(fid),
                'nickname': nickname,
                'furnace_lv': int(furnace_lv) if furnace_lv is not None else 0,
                'stove_lv': int(furnace_lv) if furnace_lv is not None else 0,
                'stove_lv_content': stove_lv_content,
                'kid': kid,
                'alliance': int(alliance_id),
                'alliance_id': int(alliance_id),
                'avatar_image': avatar_image,
            }
            
            self._log_debug(f"_upsert_member_from_api called for {fid}. Mongo Enabled: {mongo_enabled()}")
            
            try:
                if mongo_enabled() and AllianceMembersAdapter is not None:
                    self._log_debug(f"Attempting Mongo upsert for {fid}...")
                    result = AllianceMembersAdapter.upsert_member(str(fid), member_doc)
                    self._log_debug(f"Mongo upsert result: {result}")
                    if result:
                        return True
                else:
                    self._log_debug(f"Mongo disabled or Adapter None. Skipping Mongo.")
            except Exception as e:
                self._log_debug(f"Mongo upsert exception: {e}")
                pass
            
            try:
                db_path = os.path.abspath('db/users.sqlite')
                self._log_debug(f"Attempting SQLite upsert for {fid} at {db_path}...")
                with sqlite3.connect('db/users.sqlite') as users_db:
                    cursor = users_db.cursor()
                    cursor.execute("""
                        CREATE TABLE IF NOT EXISTS users (
                            fid TEXT PRIMARY KEY,
                            nickname TEXT,
                            furnace_lv INTEGER,
                            stove_lv_content TEXT,
                            kid TEXT,
                            alliance INTEGER,
                            avatar_image TEXT
                        )
                    """)
                    cursor.execute("""
                        INSERT OR REPLACE INTO users 
                        (fid, nickname, furnace_lv, stove_lv_content, kid, alliance, avatar_image)
                        VALUES (?, ?, ?, ?, ?, ?, ?)
                    """, (
                        str(fid),
                        nickname,
                        furnace_lv,
                        stove_lv_content,
                        kid,
                        alliance_id,
                        avatar_image
                    ))
                    users_db.commit()
                    self._log_debug(f"SQLite upsert committed successfully.")
                    return True
            except Exception as e:
                self._log_debug(f"Failed to save member {fid}: {e}")
                return False
                
        except Exception as e:
            self._log_debug(f"Error in _upsert_member_from_api: {e}")
            return False

    async def log_action(self, action_type: str, user_id: int, guild_id: int, details: dict):
        try:
            log_file_path = os.path.join(self.log_directory, 'id_channel_log.txt')
            with open(log_file_path, 'a', encoding='utf-8') as log_file:
                timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                log_file.write(f"\n[{timestamp}] {action_type}\n")
                log_file.write(f"User ID: {user_id}\n")
                cursor = db.cursor()
                cursor.execute("SELECT channel_id, alliance_id FROM id_channels")
                channels = cursor.fetchall()

            invalid_channels = []
            for channel_id, alliance_id in channels:
                channel = self.bot.get_channel(channel_id)
                if not channel:
                    invalid_channels.append(channel_id)
                    continue

                async for message in channel.history(limit=None, after=datetime.utcnow() - timedelta(days=1)):
                    if message.author.bot:
                        continue

                    has_bot_reaction = False
                    for reaction in message.reactions:
                        async for user in reaction.users():
                            if user == self.bot.user:
                                has_bot_reaction = True
                                break
                        if has_bot_reaction:
                            break

                    if has_bot_reaction:
                        continue

                    content = message.content.strip()
                    if not content or not content.isdigit():
                        continue

                    fid = int(content)
                    await self.process_fid(message, fid, alliance_id)

            if invalid_channels:
                with sqlite3.connect('db/id_channel.sqlite') as db:
                    cursor = db.cursor()
                    placeholders = ','.join('?' * len(invalid_channels))
                    cursor.execute(f"""
                        DELETE FROM id_channels 
                        WHERE channel_id IN ({placeholders})
                    """, invalid_channels)
        custom_id="delete_id_channel",
        row=0
    )
    async def delete_channel_button(self, interaction: discord.Interaction, button: discord.ui.Button):
        try:
            channels = []
            with sqlite3.connect('db/id_channel.sqlite') as db:
                cursor = db.cursor()
                cursor.execute("SELECT channel_id, alliance_id FROM id_channels WHERE guild_id = ?", (interaction.guild_id,))
                id_channels = cursor.fetchall()

            with sqlite3.connect('db/alliance.sqlite') as alliance_db:
                alliance_cursor = alliance_db.cursor()
                for channel_id, alliance_id in id_channels:
                    alliance_cursor.execute("SELECT name FROM alliance_list WHERE alliance_id = ?", (alliance_id,))
                    alliance_name = alliance_cursor.fetchone()
                    if alliance_name:
                        channels.append((channel_id, alliance_name[0]))

            if not channels:
                await interaction.response.send_message(
                    "‚ùå No active ID channels found in this server.",
                    ephemeral=True
                )
                return

            options = []
            for channel_id, alliance_name in channels:
                channel = interaction.guild.get_channel(channel_id)
                if channel:
                    options.append(
                        discord.SelectOption(
                            label=f"#{channel.name}",
                            value=str(channel_id),
                            description=f"Alliance: {alliance_name}"
                        )
                    )

            class ChannelSelect(discord.ui.Select):
                def __init__(self):
                    super().__init__(
                        placeholder="Select ID channel to delete",
                        options=options,
                        custom_id="delete_channel_select"
                    )

                async def callback(self, select_interaction: discord.Interaction):
                    try:
                        channel_id = int(self.values[0])
                        
                        # await self.view.cog.stop_channel_listener(channel_id) # Removed as not implemented

                        with sqlite3.connect('db/id_channel.sqlite') as db:
                            cursor = db.cursor()
                            cursor.execute("DELETE FROM id_channels WHERE channel_id = ?", (channel_id,))
                            db.commit()

                        channel = select_interaction.guild.get_channel(channel_id)
                        
                        await self.view.cog.log_action(
                            "DELETE_CHANNEL",
                            select_interaction.user.id,
                            select_interaction.guild_id,
                            {
                                "channel_id": channel_id,
                                "channel_name": channel.name if channel else "Unknown"
                            }
                        )

                        success_embed = discord.Embed(
                            title="‚úÖ ID Channel Deleted",
                            description=f"**Channel:** {channel.mention if channel else 'Deleted Channel'}\n\n"
                                      f"This channel will no longer be used as an ID channel.",
                            color=discord.Color.green()
                        )
                        
                        if not select_interaction.response.is_done():
                            await select_interaction.response.edit_message(embed=success_embed, view=None)
                        else:
                            await select_interaction.message.edit(embed=success_embed, view=None)
                            
                    except Exception as e:
                        error_embed = discord.Embed(
                            title="‚ùå Error",
                            description="An error occurred while deleting the channel.",
                            color=discord.Color.red()
                        )
                        if not select_interaction.response.is_done():
        row=0
    )
    async def create_channel_button(self, interaction: discord.Interaction, button: discord.ui.Button):
        try:
            with sqlite3.connect('db/alliance.sqlite') as alliance_db:
                cursor = alliance_db.cursor()
                cursor.execute("SELECT alliance_id, name FROM alliance_list")
                alliances = cursor.fetchall()

            if not alliances:
                await interaction.response.send_message(
                    "‚ùå No alliances found.", 
                    ephemeral=True
                )
                return

            options = [
                discord.SelectOption(
                    label=name,
                    value=str(alliance_id),
                    description=f"Alliance ID: {alliance_id}"
                ) for alliance_id, name in alliances
            ]

            class AllianceSelect(discord.ui.Select):
                def __init__(self):
                    super().__init__(
                        placeholder="Select an alliance",
                        options=options,
                        custom_id="alliance_select"
                    )

                async def callback(self, select_interaction: discord.Interaction):
                    alliance_id = int(self.values[0])
                    
                    class ChannelSelect(discord.ui.ChannelSelect):
                        def __init__(self):
                            super().__init__(
                                placeholder="Select a channel to use as ID channel",
                                channel_types=[discord.ChannelType.text]
                            )

                        async def callback(self, channel_interaction: discord.Interaction):
                            selected_channel = self.values[0]
                            
                            try:
                                with sqlite3.connect('db/id_channel.sqlite') as db:
                                    cursor = db.cursor()
                                    cursor.execute("""
                                        INSERT INTO id_channels 
                                        (guild_id, alliance_id, channel_id, created_at, created_by)
                                        VALUES (?, ?, ?, ?, ?)
                                    """, (
                                        channel_interaction.guild_id,
                                        alliance_id,
                                        selected_channel.id,
                                        datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                                        channel_interaction.user.id
                                    ))
                                    db.commit()

                                success_embed = discord.Embed(
                                    title="‚úÖ ID Channel Created",
                                    description=f"**Channel:** {selected_channel.mention}\n"
                                              f"**Alliance:** {dict(alliances)[alliance_id]}\n\n"
                                              f"This channel will now automatically check and add FIDs to the alliance.",
                                    color=discord.Color.green()
                                )
                                await channel_interaction.response.edit_message(embed=success_embed, view=None)

                            except sqlite3.IntegrityError:
                                error_embed = discord.Embed(
                                    title="‚ùå Error",
                                    description="This channel is already being used as an ID channel!",
                                    color=discord.Color.red()
                                )
                                await channel_interaction.response.edit_message(embed=error_embed, view=None)
                            except Exception as e:
                                error_embed = discord.Embed(
                                    title="‚ùå Error",
                                    description="An error occurred while creating the ID channel.",
                                    color=discord.Color.red()
                                )
                                await channel_interaction.response.edit_message(embed=error_embed, view=None)

                    view = discord.ui.View()
                    view.cog = self.view.cog
                    view.add_item(ChannelSelect())
                    
                    channel_embed = discord.Embed(
                        title="üìù Select Channel",
                        description="Select a text channel to use as the ID channel:",
                        color=discord.Color.blue()
                    )
                    
                    await select_interaction.response.edit_message(embed=channel_embed, view=view)

            view = discord.ui.View()
            view.cog = self.cog
            view.add_item(AllianceSelect())
            
            select_embed = discord.Embed(
                title="üè∞ Select Alliance",
                description="Select an alliance for the ID channel:",
                color=discord.Color.blue()
            )
            
            await interaction.response.send_message(
                embed=select_embed,
                view=view,
                ephemeral=True
            )

        except Exception as e:
            await interaction.response.send_message(
                "‚ùå An error occurred. Please try again.",
                ephemeral=True
            )

@commands.command(name='idchannel')
@commands.has_permissions(administrator=True)
async def show_id_channel_menu(ctx):
    """Shows the ID Channel management menu"""
    cog = ctx.bot.get_cog('IDChannel')
    if not cog:
        await ctx.send("‚ùå ID Channel system is not loaded!")
        return

    embed = discord.Embed(
        title="üÜî ID Channel Management",
        description=(
            "Manage ID channels for automatic FID registration.\n\n"
            "**Features:**\n"
            "‚Ä¢ Create ID channels linked to alliances\n"
            "‚Ä¢ View all active ID channels\n"
            "‚Ä¢ Delete ID channels\n\n"
            "Use the buttons below to manage ID channels."
        ),
        color=discord.Color.blue()
    )

    view = IDChannelView(cog)
    await ctx.send(embed=embed, view=view)

async def setup(bot):
    cog = IDChannel(bot)
    await bot.add_cog(cog)
    bot.add_command(show_id_channel_menu)